<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Transcripciones</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">Bienvenido, <span id="username">Usuario</span></h1>
    <div class="flex justify-between items-center mb-4">
      <select id="projectSelector" class="bg-gray-800 text-white px-4 py-2 rounded"></select>
      <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Cerrar sesi√≥n</button>
    </div>

    <div class="bg-gray-800 p-4 rounded mb-4">
      <h2 class="text-xl font-semibold mb-2">Subir o Grabar Audio</h2>
      <input type="file" id="audioInput" accept="audio/*" class="mb-2">
      <button onclick="uploadAudio()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mr-2">Subir Audio</button>
      <button onclick="startRecording()" id="recordBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded mr-2">Grabar</button>
      <button onclick="stopRecording()" id="stopBtn" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded hidden">Detener</button>
    </div>

    <div class="bg-gray-800 p-4 rounded mb-4">
      <h2 class="text-xl font-semibold mb-2">Transcripciones</h2>
      <ul id="transcriptionList" class="space-y-2"></ul>
    </div>
  </div>

  <script>
    let currentProject = null;
    let mediaRecorder;
    let audioChunks = [];

    async function fetchUser() {
      const res = await fetch("/me");
      if (res.ok) {
        const user = await res.json();
        document.getElementById("username").textContent = user.name;
        fetchProjects();
      } else {
        location.href = "/login.html";
      }
    }

    async function fetchProjects() {
      const res = await fetch("/proyectos");
      const proyectos = await res.json();
      const selector = document.getElementById("projectSelector");
      selector.innerHTML = "";
      proyectos.forEach(p => {
        const option = document.createElement("option");
        option.value = p;
        option.textContent = p;
        selector.appendChild(option);
      });
      if (proyectos.length > 0) {
        currentProject = proyectos[0];
        loadTranscriptions(currentProject);
      }
      selector.onchange = () => {
        currentProject = selector.value;
        loadTranscriptions(currentProject);
      };
    }

    async function loadTranscriptions(project) {
      const res = await fetch(`/proyecto/${project}/transcripciones`);
      const transcripciones = await res.json();
      const list = document.getElementById("transcriptionList");
      list.innerHTML = "";
      transcripciones.forEach((t, i) => {
        const li = document.createElement("li");
        li.className = "bg-gray-700 p-3 rounded flex justify-between items-center";
        li.innerHTML = `
          <span>${t}</span>
          <div class="space-x-2">
            <button onclick="playTranscript('${t}')" class="text-green-400 hover:underline">Reproducir</button>
            <button onclick="viewTranscript('${t}')" class="text-blue-400 hover:underline">Ver</button>
            <button onclick="deleteTranscript('${t}')" class="text-red-400 hover:underline">Eliminar</button>
            <button onclick="showPreprocessing('${t}')" class="text-yellow-400 hover:underline">Preprocesamiento</button>
          </div>
        `;
        list.appendChild(li);
      });
    }

    async function uploadAudio() {
      const file = document.getElementById("audioInput").files[0];
      if (!file || !currentProject) return alert("Selecciona un archivo de audio y proyecto");
      const formData = new FormData();
      formData.append("audio", file);
      formData.append("nombre_proyecto", currentProject);
      await fetch("/upload", { method: "POST", body: formData });
      loadTranscriptions(currentProject);
    }

    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks);
          const file = new File([audioBlob], "grabacion.wav");
          const formData = new FormData();
          formData.append("audio", file);
          formData.append("nombre_proyecto", currentProject);
          await fetch("/upload", { method: "POST", body: formData });
          loadTranscriptions(currentProject);
        };
        audioChunks = [];
        mediaRecorder.start();
        document.getElementById("recordBtn").classList.add("hidden");
        document.getElementById("stopBtn").classList.remove("hidden");
      });
    }

    function stopRecording() {
      mediaRecorder.stop();
      document.getElementById("recordBtn").classList.remove("hidden");
      document.getElementById("stopBtn").classList.add("hidden");
    }

    async function playTranscript(id) {
      const audio = new Audio(`/audio/${currentProject}/${id}`);
      audio.play();
    }

    function viewTranscript(id) {
      window.open(`/transcripcion/${currentProject}/${id}`, '_blank');
    }

    async function deleteTranscript(id) {
      await fetch(`/transcripcion/${currentProject}/${id}`, { method: "DELETE" });
      loadTranscriptions(currentProject);
    }

    async function showPreprocessing(id) {
      const res = await fetch(`/preprocesamiento?proyecto=${currentProject}&archivo=${id}`);
      const text = await res.text();
      alert(`Preprocesamiento de ${id}:\n\n` + text);
    }

    async function logout() {
      await fetch("/logout");
      location.href = "/login.html";
    }

    fetchUser();
  </script>
</body>
</html>
